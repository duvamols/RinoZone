<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Impostor ¬∑ Vertical Pro</title>

  <style>
    :root{
      --bg0:#05060d;
      --bg1:#0b1020;
      --bg2:#020617;

      --panel: rgba(15, 23, 42, 0.84);
      --panel2: rgba(2, 6, 23, 0.58);
      --stroke: rgba(148, 163, 184, 0.20);

      --text:#f8fafc;
      --muted:#cbd5f5;

      --cyan:#22d3ee;
      --violet:#a78bfa;
      --pink:#fb7185;
      --lime:#34d399;
      --amber:#fbbf24;

      --good:#22c55e;
      --bad:#fb7185;

      --shadow: 0 28px 80px rgba(0,0,0,.52), inset 0 1px 0 rgba(255,255,255,0.06);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body{ height:100%; width:100%; }

    body{
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      color:var(--text);
      padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      overflow:hidden;
      touch-action: manipulation;
      -webkit-user-select:none;
      user-select:none;

      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(900px 520px at 85% 18%, rgba(167,139,250,0.22), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(251,191,36,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    #app{ width:100%; display:flex; justify-content:center; }

    .shell{
      width: min(720px, 100%);
      background: linear-gradient(180deg, var(--panel), rgba(15,23,42,0.68));
      border:1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      display:flex;
      flex-direction:column;
      min-height: calc(100dvh - 24px);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(148,163,184,0.16);
      position:sticky;
      top:0;
      z-index:10;
      background: linear-gradient(180deg, rgba(2,6,23,0.35), rgba(2,6,23,0.08));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:16px;
      display:grid; place-items:center;
      background: radial-gradient(20px 20px at 30% 30%, rgba(255,255,255,0.14), transparent 60%),
                  linear-gradient(135deg, rgba(34,211,238,0.92), rgba(167,139,250,0.92));
      border:1px solid rgba(255,255,255,0.16);
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      font-size:22px;
      flex: 0 0 auto;
    }
    .brand h1{
      font-size: 14px;
      font-weight: 1100;
      letter-spacing:.2px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin-top:2px;
      font-size: 12px;
      color: rgba(203,213,245,0.92);
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .hud{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(2,6,23,0.44);
      border:1px solid rgba(148,163,184,0.18);
      font-size: 12px;
      font-weight: 950;
      color: rgba(248,250,252,0.96);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .chip b{ font-weight: 1200; }

    main{
      position:relative;
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 14px;
    }

    .panel{
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
      border-radius: 22px;
      padding: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }

    h2{
      font-size: 18px;
      font-weight: 1200;
      letter-spacing:.2px;
      margin-bottom: 8px;
    }
    p{ font-size: 13px; font-weight: 850; color: rgba(203,213,245,0.92); line-height:1.35; }
    .help{ margin-top:8px; font-size:12px; color: rgba(203,213,245,0.88); font-weight:800; }
    .warn{ margin-top:10px; font-size:12px; color: rgba(251,113,133,0.98); font-weight:950; }
    .ok{ margin-top:10px; font-size:12px; color: rgba(34,197,94,0.98); font-weight:950; }

    label{
      display:block;
      font-size:12px;
      font-weight: 1100;
      letter-spacing:.2px;
      color: rgba(248,250,252,0.96);
      margin: 10px 0 6px;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(2,6,23,0.42);
      border:1px solid rgba(148,163,184,0.22);
      color: rgba(248,250,252,0.98);
      outline:none;
      font-size:14px;
      font-weight: 950;
    }
    input::placeholder{ color: rgba(203,213,245,0.55); font-weight:800; }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:12px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:520px){
      .grid2{ grid-template-columns:1fr 1fr; }
      .brand h1{ font-size:15px; }
    }

    .btn{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.44);
      color: rgba(248,250,252,0.98);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 1100;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .08s ease;
    }
    .btn:active{ transform: translateY(1px); filter: brightness(1.04); }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; }

    .btn-primary{
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(167,139,250,0.92));
      box-shadow: 0 16px 44px rgba(0,0,0,0.35);
    }
    .btn-danger{
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(251,113,133,0.98), rgba(251,191,36,0.74));
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(2,6,23,0.86);
      border:1px solid rgba(148,163,184,0.22);
      color: rgba(248,250,252,0.98);
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 950;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 999;
      max-width: min(520px, 92vw);
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
    #toast.bad{ border-color: rgba(251,113,133,0.45); }
    #toast.good{ border-color: rgba(34,197,94,0.45); }

    /* iOS Hint */
    #iosHint{
      margin-top:12px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
      display:none;
    }
    #iosHint .row{ margin-top:0; }
    #iosHint .ttl{ font-weight:1200; font-size:13px; }
    #iosHint .mut{ font-weight:850; font-size:12px; color: rgba(203,213,245,0.92); line-height:1.35; }
    #iosHint .x{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.44);
      color: rgba(248,250,252,0.98);
      padding: 8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:1100;
    }

    /* Secret Card (Vertical first) */
    .revealWrap{ display:flex; flex-direction:column; gap:12px; align-items:stretch; margin-top:10px; }
    .secretCard{
      position:relative;
      width:100%;
      border-radius: 26px;
      padding: 14px 14px 16px;
      background:
        radial-gradient(520px 240px at 25% 18%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(520px 240px at 80% 30%, rgba(167,139,250,0.20), transparent 60%),
        rgba(2,6,23,0.54);
      border:1px solid rgba(148,163,184,0.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 16px 50px rgba(0,0,0,0.45);
      overflow:hidden;
    }
    .secretHeader{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 8px 0 6px;
      text-align:center;
    }
    .avatarIcon{
      width:58px; height:58px;
      border-radius: 22px;
      display:grid; place-items:center;
      background: radial-gradient(22px 22px at 28% 28%, rgba(255,255,255,0.16), transparent 60%),
                  linear-gradient(135deg, rgba(251,191,36,0.92), rgba(251,113,133,0.92));
      border:1px solid rgba(255,255,255,0.18);
      box-shadow: 0 16px 46px rgba(0,0,0,0.35);
      font-size: 26px;
    }
    .playerName{
      font-size: 18px;
      font-weight: 1250;
      letter-spacing:.2px;
      color: rgba(248,250,252,0.98);
    }

    .secretCard .role{
      margin-top:8px;
      text-align:center;
      font-size: 14px;
      font-weight: 1200;
      letter-spacing:.4px;
    }
    .secretCard .word{
      text-align:center;
      font-size: 34px;
      font-weight: 1300;
      letter-spacing: .6px;
      margin-top: 10px;
      text-transform: uppercase;
    }

    .secretCard .mask{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      background:
        radial-gradient(520px 260px at 28% 22%, rgba(34,211,238,0.18), transparent 62%),
        radial-gradient(520px 260px at 80% 34%, rgba(167,139,250,0.18), transparent 62%),
        rgba(0,0,0,0.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: opacity .12s ease;
    }
    .secretCard.revealed .mask{ opacity:0; pointer-events:none; }
    .maskInner{
      width:100%;
      border-radius: 22px;
      padding: 12px 12px;
      background: rgba(2,6,23,0.58);
      border:1px solid rgba(148,163,184,0.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      text-align:center;
    }
    .maskInner h3{ font-size: 14px; font-weight: 1250; margin-bottom:6px; }
    .maskInner p{ margin:0; font-size: 12px; font-weight: 850; color: rgba(203,213,245,0.92); }
    .holdBtn{
      margin-top: 10px;
      width:100%;
      padding: 14px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(167,139,250,0.92));
      color: rgba(248,250,252,0.98);
      font-size: 14px;
      font-weight: 1200;
      cursor:pointer;
      user-select:none;
      touch-action:none;
    }
    .holdBtn:active{ filter: brightness(1.04); transform: translateY(1px); }

    .bottomNext{
      margin-top: 10px;
      width:100%;
      padding: 14px 12px;
      border-radius: 18px;
      font-size: 14px;
      font-weight: 1200;
    }

    /* Voting list */
    .playersList{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .voteItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(2,6,23,0.38);
      border:1px solid rgba(148,163,184,0.18);
    }
    .voteItem .nm{ font-weight: 1150; font-size: 14px; letter-spacing:.2px; }
    .voteItem small{ color: rgba(203,213,245,0.88); font-weight: 850; font-size: 12px; }
    .radio{ width:22px; height:22px; accent-color: #22d3ee; cursor:pointer; }

    /* End summary cards */
    .resultCard{
      margin-top: 12px;
      border-radius: 22px;
      padding: 12px 12px;
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
    }
    .resultCard .ttl{ font-weight:1200; font-size: 14px; margin-bottom:6px; }
    .resultCard .mut{ font-weight:850; font-size: 12px; color: rgba(203,213,245,0.92); }

  </style>
</head>

<body>
  <div id="app">
    <div class="shell">
      <header>
        <div class="brand" aria-label="Encabezado del juego">
          <div class="logo" aria-hidden="true">üïµÔ∏è</div>
          <div style="min-width:0">
            <h1>Impostor</h1>
            <p>Vertical ¬∑ tarjetas privadas ¬∑ votaciones</p>
          </div>
        </div>
        <div class="hud" aria-label="Indicadores">
          <div class="chip">ü™ô <b id="hudCoins">0</b></div>
          <div class="chip">üé≤ Ronda <b id="hudRound">0</b></div>
          <div class="chip">üó≥ Votos <b id="hudVotesLeft">0</b></div>
        </div>
      </header>

      <main id="stage" aria-live="polite"></main>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
"use strict";

/* =========================================================
 *  VISUAL/TOUCH BEST PRACTICES (mobile-first + iOS hint)
 *  - Fullscreen requires user gesture (browsers enforce it)
 *  - iOS Safari "true fullscreen" is limited; recommend A2HS
 *  ========================================================= */
const iosHint = document.createElement("div");
iosHint.id = "iosHint";

function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}
function isStandalone(){
  return (window.navigator.standalone === true) || window.matchMedia("(display-mode: standalone)").matches;
}
async function requestFullscreenSafe(){
  const el = document.documentElement;
  try{
    if(el.requestFullscreen) await el.requestFullscreen();
    else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  }catch(_){}
}
function showIOSHint(){
  const isMobile = Math.min(window.innerWidth, window.innerHeight) <= 900;
  if(isIOS() && isMobile && !isStandalone()){
    iosHint.style.display = "block";
    iosHint.innerHTML = `
      <div class="row">
        <div style="min-width:0">
          <div class="ttl">iPhone (Safari)</div>
          <div class="mut">Para verlo tipo app (sin barras): <b>Compartir ‚Üí A√±adir a pantalla de inicio</b> y √°brelo desde ah√≠.</div>
        </div>
        <button class="x" type="button" aria-label="Cerrar">‚úï</button>
      </div>
    `;
    iosHint.querySelector(".x")?.addEventListener("click", () => (iosHint.style.display = "none"), { once:true });
  } else {
    iosHint.style.display = "none";
  }
}
showIOSHint();
window.addEventListener("resize", showIOSHint);
window.visualViewport?.addEventListener("resize", showIOSHint);

/* =========================================================
 *  WORD BANK (>= 1000) - generated via combinations
 *  We keep a base list of nouns (Spanish) and expand with
 *  modifiers to easily exceed 1000 unique "palabras/phrases".
 * ========================================================= */
const BASE_NOUNS = [
  "silla",
  "mesa",
  "ventana",
  "puerta",
  "llave",
  "candado",
  "cortina",
  "espejo",
  "alfombra",
  "lampara",
  "reloj",
  "cama",
  "almohada",
  "sabana",
  "cobija",
  "armario",
  "cajon",
  "gaveta",
  "estante",
  "cuadro",
  "libro",
  "cuaderno",
  "lapiz",
  "boligrafo",
  "borrador",
  "sacapuntas",
  "mochila",
  "maleta",
  "cargador",
  "audifonos",
  "celular",
  "tablet",
  "computador",
  "teclado",
  "mouse",
  "pantalla",
  "control",
  "camara",
  "tripode",
  "bateria",
  "parlante",
  "microfono",
  "router",
  "cable",
  "enchufe",
  "bombillo",
  "ventilador",
  "nevera",
  "estufa",
  "horno",
  "licuadora",
  "cafetera",
  "tetera",
  "jarra",
  "vaso",
  "taza",
  "plato",
  "cuchara",
  "tenedor",
  "cuchillo",
  "olla",
  "sarten",
  "espatula",
  "colador",
  "recipiente",
  "termo",
  "servilleta",
  "bolsa",
  "caja",
  "frasco",
  "pan",
  "queso",
  "huevo",
  "arroz",
  "pasta",
  "sopa",
  "ensalada",
  "pollo",
  "carne",
  "pescado",
  "atun",
  "fruta",
  "manzana",
  "pera",
  "banano",
  "uvas",
  "mango",
  "pi√±a",
  "papaya",
  "fresa",
  "sandia",
  "naranja",
  "limon",
  "tomate",
  "cebolla",
  "ajo",
  "papa",
  "yuca",
  "platano",
  "zanahoria",
  "maiz",
  "chocolate",
  "cafe",
  "te",
  "jugo",
  "agua",
  "leche",
  "yogur",
  "miel",
  "azucar",
  "sal",
  "pimienta",
  "comino",
  "canela",
  "vainilla",
  "helado",
  "galleta",
  "torta",
  "brownie",
  "churro",
  "empanada",
  "tamal",
  "hamburguesa",
  "pizza",
  "sushi",
  "taco",
  "burrito",
  "arequipe",
  "chicharron",
  "frijol",
  "lenteja",
  "garbanzo",
  "aguacate",
  "pepino",
  "lechuga",
  "espinaca",
  "brocoli",
  "coliflor",
  "remolacha",
  "calabaza",
  "quesadilla",
  "plaza",
  "calle",
  "avenida",
  "puente",
  "tunel",
  "estacion",
  "terminal",
  "aeropuerto",
  "puerto",
  "playa",
  "monta√±a",
  "bosque",
  "selva",
  "rio",
  "cascada",
  "lago",
  "laguna",
  "desierto",
  "isla",
  "volcan",
  "cueva",
  "ciudad",
  "pueblo",
  "barrio",
  "casa",
  "edificio",
  "oficina",
  "colegio",
  "universidad",
  "biblioteca",
  "hospital",
  "clinica",
  "farmacia",
  "mercado",
  "tienda",
  "supermercado",
  "restaurante",
  "cafeteria",
  "panaderia",
  "hotel",
  "museo",
  "teatro",
  "estadio",
  "gimnasio",
  "iglesia",
  "paradero",
  "parqueadero",
  "estacionamiento",
  "cancha",
  "gato",
  "caballo",
  "vaca",
  "oveja",
  "cabra",
  "cerdo",
  "pato",
  "ganso",
  "conejo",
  "raton",
  "hamster",
  "tortuga",
  "iguana",
  "serpiente",
  "tigre",
  "leon",
  "jaguar",
  "oso",
  "lobo",
  "zorro",
  "mono",
  "perezoso",
  "delfin",
  "ballena",
  "tiburon",
  "pulpo",
  "calamar",
  "cangrejo",
  "langosta",
  "pinguino",
  "aguila",
  "halcon",
  "paloma",
  "colibri",
  "loro",
  "tucan",
  "buho",
  "murcielago",
  "abeja",
  "mariposa",
  "hormiga",
  "arana",
  "escorpion",
  "rana",
  "sapo",
  "tormenta",
  "nieve",
  "viento",
  "sol",
  "nube",
  "arcoiris",
  "trueno",
  "relampago",
  "neblina",
  "hielo",
  "fuego",
  "ceniza",
  "arena",
  "roca",
  "piedra",
  "madera",
  "hoja",
  "flor",
  "semilla",
  "raiz",
  "tronco",
  "corteza",
  "rama",
  "jardin",
  "huerta",
  "mar",
  "oceano",
  "planeta",
  "estrella",
  "baloncesto",
  "tenis",
  "voleibol",
  "natacion",
  "ciclismo",
  "atletismo",
  "boxeo",
  "ajedrez",
  "dardos",
  "bolos",
  "patinaje",
  "senderismo",
  "campamento",
  "pesca",
  "cine",
  "musica",
  "concierto",
  "karaoke",
  "baile",
  "videojuego",
  "rompecabezas",
  "cartas",
  "enfermera",
  "profesor",
  "estudiante",
  "ingeniero",
  "abogado",
  "policia",
  "bombero",
  "cocinero",
  "panadero",
  "barbero",
  "mecanico",
  "piloto",
  "arquitecto",
  "dise√±ador",
  "musico",
  "cantante",
  "actor",
  "pintor",
  "fotografo",
  "periodista",
  "vendedor",
  "cajero",
  "constructor",
  "agricultor",
  "pescador",
  "chef",
  "navegador",
  "aplicacion",
  "codigo",
  "algoritmo",
  "robot",
  "dron",
  "sensor",
  "gps",
  "bluetooth",
  "contrasena",
  "correo",
  "mensaje",
  "notificacion",
  "perfil",
  "usuario",
  "conexion",
  "seguridad",
  "cifrado",
  "chat",
  "streaming",
  "red",
  "amigo",
  "fiesta",
  "cumpleanos",
  "regalo",
  "sorpresa",
  "viaje",
  "aventura",
  "misterio",
  "secreto",
  "historia",
  "leyenda",
  "tesoro",
  "mapa",
  "brujula",
  "retrato",
  "documento",
  "contrato",
  "dinero",
  "moneda",
  "billete",
  "tarjeta",
  "banco",
  "deuda",
  "ahorro",
  "negocio",
  "mercancia",
  "envio",
  "paquete",
  "carta",
  "sello",
  "firma",
  "reunion",
  "decicion",
  "meta"
];

const MODIFIERS = [
  "gigante","mini","secreto","magico","antiguo","futurista","dorado","nocturno","de bolsillo","de emergencia","de lujo"
];

// build > 1000 unique entries
function buildWordBank(){
  const set = new Set();
  for(const n of BASE_NOUNS){
    set.add(n);
    for(const m of MODIFIERS){
      set.add(`${n} ${m}`);
    }
  }
  // ensure enough: if still below 1100, add combos with "del" patterns
  const extraMods = ["del norte","del sur","del bosque","de la ciudad","del mar","de la monta√±a","del tiempo","del espacio"];
  for(const n of BASE_NOUNS){
    for(const e of extraMods){
      set.add(`${n} ${e}`);
    }
  }
  return Array.from(set);
}

function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* =========================================================
 *  STATE
 * ========================================================= */
const stage = document.getElementById("stage");
const toastEl = document.getElementById("toast");

const hudCoins = document.getElementById("hudCoins");
const hudRound = document.getElementById("hudRound");
const hudVotesLeft = document.getElementById("hudVotesLeft");

const state = {
  step: "home",
  playerCount: 4,
  players: [], // {id,name,role,alive,coins}
  impostorCount: 1,

  // round
  round: 0,
  votesLeftThisGame: 0,   // = impostorCount initially
  votesUsed: 0,

  // reveal
  revealIndex: 0,

  // words
  wordBank: shuffle(buildWordBank()),
  usedWords: new Set(),
  secretWord: "",

  // voting flow
  voteRoundIndex: 0,     // 0..votesLeftThisGame-1
  voterIndex: 0,         // which player is voting now
  votes: new Map(),      // suspectId -> count
  votedBy: new Set(),    // voterId set

  // impostor guess
  aliveImpostorIds: [],
  guessIndex: 0,
  impostorGuesses: new Map(), // impostorId -> guess string

  // winner
  finished: false,
  winner: ""
};

/* =========================================================
 *  UTIL
 * ========================================================= */
function el(tag, attrs={}, children=[]){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k === "class") n.className = v;
    else if(k === "style") n.setAttribute("style", v);
    else if(k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  for(const c of (children||[])){
    if(c === null || c === undefined) continue;
    if(typeof c === "string") n.appendChild(document.createTextNode(c));
    else n.appendChild(c);
  }
  return n;
}

let toastTimer = null;
function toast(msg, bad=false){
  toastEl.textContent = msg;
  toastEl.className = "";
  toastEl.classList.add("show");
  toastEl.classList.add(bad ? "bad" : "good");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1600);
}

function clearStage(){
  stage.innerHTML = "";
}

function norm(s){
  return (s||"")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function getAlivePlayers(){
  return state.players.filter(p => p.alive);
}
function getAliveImpostors(){
  return state.players.filter(p => p.alive && p.role === "impostor");
}
function getAliveCivilians(){
  return state.players.filter(p => p.alive && p.role === "civil");
}

function updateHUD(){
  const totalCoins = state.players.reduce((a,p) => a + (p.coins||0), 0);
  hudCoins.textContent = String(totalCoins);
  hudRound.textContent = String(state.round);
  const left = Math.max(0, state.votesLeftThisGame - state.votesUsed);
  hudVotesLeft.textContent = String(left);
}

function setStep(step){
  state.step = step;
  render();
}

/* =========================================================
 *  GAME CORE
 * ========================================================= */
function pickSecretWord(){
  // avoid repeats within session until bank cycles
  for(let tries=0; tries < state.wordBank.length; tries++){
    const w = state.wordBank.shift();
    state.wordBank.push(w); // rotate
    const key = norm(w);
    if(!state.usedWords.has(key)){
      state.usedWords.add(key);
      return w;
    }
  }
  // fallback: allow repeat
  return state.wordBank[Math.floor(Math.random()*state.wordBank.length)];
}

function assignRoles(){
  // reset player states
  for(const p of state.players){
    p.role = "civil";
    p.alive = true;
  }
  // choose impostors randomly
  const ids = state.players.map(p => p.id);
  shuffle(ids);
  const chosen = new Set(ids.slice(0, state.impostorCount));
  for(const p of state.players){
    if(chosen.has(p.id)) p.role = "impostor";
  }
}

function startNewGame(){
  state.finished = false;
  state.winner = "";

  state.round = 1;
  state.votesUsed = 0;
  state.votesLeftThisGame = state.impostorCount;

  state.revealIndex = 0;

  state.secretWord = pickSecretWord();

  assignRoles();

  // prepare guess list each cycle
  state.aliveImpostorIds = getAliveImpostors().map(p => p.id);
  state.guessIndex = 0;
  state.impostorGuesses = new Map();

  updateHUD();
  setStep("reveal");
}

function awardRoundCoins(){
  // each player +2 coins per round (as requested)
  for(const p of state.players){
    p.coins = (p.coins||0) + 2;
  }
  updateHUD();
}

function beginVotingCycle(){
  state.votes = new Map();
  state.votedBy = new Set();
  state.voterIndex = 0;
  state.voteRoundIndex = state.votesUsed + 1;
  setStep("vote_turn");
}

function tallyVotes(){
  // Determine top-voted among alive players (excluding self-votes allowed? allow, but usually not)
  const alive = getAlivePlayers();
  if(alive.length <= 1) return null;

  let max = 0;
  let top = [];
  for(const p of alive){
    const c = state.votes.get(p.id) || 0;
    if(c > max){
      max = c;
      top = [p.id];
    } else if(c === max && c > 0){
      top.push(p.id);
    }
  }
  // If nobody voted (shouldn't happen), pick random alive
  if(max === 0){
    return alive[Math.floor(Math.random()*alive.length)].id;
  }
  // Tie-break: random among top
  return top[Math.floor(Math.random()*top.length)];
}

function eliminatePlayer(id){
  const p = state.players.find(x => x.id === id);
  if(p) p.alive = false;
}

function checkWinAfterVote(){
  const imps = getAliveImpostors().length;
  const civs = getAliveCivilians().length;
  if(imps === 0){
    state.finished = true;
    state.winner = "civiles";
    return true;
  }
  if(civs === 0){
    state.finished = true;
    state.winner = "impostores";
    return true;
  }
  if(state.votesUsed >= state.votesLeftThisGame){
    // no more votes; impostors survived without guessing => impostors win? or civs? depends.
    // We'll decide: if impostors survive all allowed votes, they win.
    state.finished = true;
    state.winner = "impostores";
    return true;
  }
  return false;
}

function beginImpostorGuessing(){
  state.aliveImpostorIds = getAliveImpostors().map(p => p.id);
  state.guessIndex = 0;
  state.impostorGuesses = new Map();
  setStep("guess_turn");
}

function checkImpostorGuessWin(){
  // If any alive impostor guessed correctly, impostors win.
  const secret = norm(state.secretWord);
  for(const [impId, guess] of state.impostorGuesses.entries()){
    if(norm(guess) === secret){
      state.finished = true;
      state.winner = "impostores";
      return true;
    }
  }
  return false;
}

/* =========================================================
 *  RENDERERS
 * ========================================================= */
function render(){
  updateHUD();

  switch(state.step){
    case "home": return renderHome();
    case "setup_count": return renderSetupCount();
    case "setup_names": return renderSetupNames();
    case "setup_impostors": return renderSetupImpostors();
    case "reveal": return renderReveal();
    case "briefing": return renderBriefing();
    case "vote_turn": return renderVoteTurn();
    case "vote_result": return renderVoteResult();
    case "guess_turn": return renderGuessTurn();
    case "guess_result": return renderGuessResult();
    case "end": return renderEnd();
    default: return renderHome();
  }
}

function renderHome(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Configurar partida"]),
    el("p",{},["Juego local para pasar el tel√©fono. Cada jugador ve su tarjeta en privado y luego hay votaciones para descubrir al impostor."]),
    iosHint,
    el("div",{class:"row"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => setStep("setup_count")},["‚ñ∂ Empezar"])
    ]),
    el("div",{class:"help"},[
      "Consejo r√°pido: en Android, toca una vez para intentar pantalla completa. En iPhone, usa ‚ÄúA√±adir a pantalla de inicio‚Äù."
    ])
  ]);

  stage.appendChild(panel);

  // arm fullscreen on first gesture (non-iOS)
  stage.addEventListener("pointerdown", () => {
    if(!isIOS() && !document.fullscreenElement){
      requestFullscreenSafe();
    }
  }, { once:true });
}

function renderSetupCount(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["¬øCu√°ntos jugadores?"]),
    el("p",{},["Define el n√∫mero de personas que van a jugar en esta ronda."]),
    el("label",{for:"pc"},["Cantidad de jugadores (3‚Äì20)"]),
    el("input",{id:"pc",type:"number",min:"3",max:"20",inputmode:"numeric",value:String(state.playerCount)}),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => setStep("home")},["‚¨Ö Volver"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        const v = Math.floor(Number(document.getElementById("pc").value||0));
        if(!Number.isFinite(v) || v < 3 || v > 20){
          toast("Ingresa un n√∫mero entre 3 y 20.", true);
          return;
        }
        state.playerCount = v;
        state.players = Array.from({length:v}).map((_,i)=>({
          id: "p"+(i+1),
          name: "Jugador "+(i+1),
          role:"civil",
          alive:true,
          coins: state.players[i]?.coins || 0
        }));
        setStep("setup_names");
      }},["Siguiente"])
    ])
  ]);

  stage.appendChild(panel);
}

function renderSetupNames(){
  clearStage();

  const list = el("div",{class:"panel"},[
    el("h2",{},["Nombres de jugadores"]),
    el("p",{},["Escribe el nombre de cada jugador. Esto se mostrar√° en la tarjeta privada y en la votaci√≥n."])
  ]);

  const wrap = el("div",{class:"grid2"});
  for(let i=0;i<state.playerCount;i++){
    const id = "nm_"+i;
    wrap.appendChild(el("div",{},[
      el("label",{for:id},[`Jugador ${i+1}`]),
      el("input",{id, type:"text", maxlength:"18", value: state.players[i]?.name || "", placeholder:"Nombre"})
    ]));
  }

  list.appendChild(wrap);
  list.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => setStep("setup_count")},["‚¨Ö Atr√°s"]),
    el("button",{class:"btn btn-primary",type:"button",onclick:() => {
      const names = [];
      for(let i=0;i<state.playerCount;i++){
        const v = (document.getElementById("nm_"+i).value||"").trim();
        if(!v){ toast("Completa todos los nombres.", true); return; }
        names.push(v);
      }
      // unique-ish check
      const normed = names.map(norm);
      const set = new Set(normed);
      if(set.size !== normed.length){
        toast("Evita nombres repetidos para votar mejor.", true);
        return;
      }
      for(let i=0;i<state.playerCount;i++){
        state.players[i].name = names[i];
        state.players[i].alive = true;
      }
      setStep("setup_impostors");
    }},["Siguiente"])
  ]));

  stage.appendChild(list);
}

function renderSetupImpostors(){
  clearStage();

  const maxImp = Math.max(1, Math.floor(state.playerCount/3));
  const defaultImp = Math.min(state.impostorCount || 1, maxImp);

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Impostores y reglas"]),
    el("p",{},["Selecciona cu√°ntos impostores habr√°. Todos los civiles ver√°n la misma palabra. Los impostores ver√°n ‚Äú‚Äî‚Äù y deber√°n deducirla."]),
    el("div",{class:"grid2"},[
      el("div",{},[
        el("label",{for:"imp"},["Cantidad de impostores"]),
        el("input",{id:"imp",type:"number",min:"1",max:String(maxImp),inputmode:"numeric",value:String(defaultImp)}),
        el("div",{class:"help"},[`M√°ximo sugerido para ${state.playerCount} jugadores: ${maxImp}.`])
      ]),
      el("div",{},[
        el("label",{for:"bankInfo"},["Banco de palabras"]),
        el("input",{id:"bankInfo",type:"text",readonly:"readonly",value:`${buildWordBank().length}+ palabras/phrases`} ),
        el("div",{class:"help"},["Se evitan repeticiones hasta agotar el banco de la sesi√≥n."])
      ])
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => setStep("setup_names")},["‚¨Ö Atr√°s"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        const v = Math.floor(Number(document.getElementById("imp").value||0));
        if(!Number.isFinite(v) || v < 1 || v > maxImp){
          toast(`El n√∫mero de impostores debe estar entre 1 y ${maxImp}.`, true);
          return;
        }
        state.impostorCount = v;
        startNewGame();
      }},["üé¥ Repartir tarjetas"])
    ]),
    el("div",{class:"help"},["Seguridad: cada jugador debe mantener presionado para revelar, y soltar para ocultar antes de pasar el tel√©fono."]),
  ]);

  stage.appendChild(panel);
}

function renderReveal(){
  clearStage();

  const total = state.players.length;
  const idx = state.revealIndex;
  const p = state.players[idx];

  const roleTxt = (p.role === "impostor") ? "IMPOSTOR" : "CIVIL";
  const roleColor = (p.role === "impostor") ? "var(--bad)" : "var(--good)";
  const wordTxt = (p.role === "impostor") ? "‚Äî" : state.secretWord;

  const card = el("div",{class:"secretCard",id:"secretCard"},[
    el("div",{class:"secretHeader"},[
      el("div",{class:"avatarIcon", "aria-hidden":"true"},["üë§"]),
      el("div",{class:"playerName"},[p.name])
    ]),
    el("div",{class:"role",style:`color:${roleColor}`},[roleTxt]),
    el("div",{class:"word"},[wordTxt]),
    el("div",{class:"mask",id:"mask",role:"button",tabindex:"0"},[
      el("div",{class:"maskInner"},[
        el("h3",{},["Tarjeta privada"]),
        el("p",{},["Aseg√∫rate de que nadie est√© mirando."]),
        el("button",{class:"holdBtn",type:"button",id:"holdBtn"},["Mant√©n presionado para ver"])
      ])
    ])
  ]);

  const nextBtn = el("button",{
    class:"btn btn-primary bottomNext",
    type:"button",
    disabled:"disabled",
    "data-next-primary":"1",
    onclick:() => {
      state.revealIndex++;
      if(state.revealIndex >= total){
        setStep("briefing");
      }else{
        setStep("reveal");
      }
    }
  },[idx === total-1 ? "‚ñ∂ Continuar" : "Siguiente jugador"]);

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Reparto de tarjetas"]),
    el("p",{},[
      `Jugador ${idx+1} de ${total}. Pasa el tel√©fono a `,
      el("b",{},[p.name]),
      "."
    ]),
    el("div",{class:"revealWrap"},[
      card,
      nextBtn
    ]),
    el("div",{class:"help"},["Para avanzar: suelta para ocultar la palabra y luego pulsa ‚ÄúSiguiente jugador‚Äù."])
  ]);

  stage.appendChild(panel);

  // Hold-to-reveal behavior (pointer-based)
  const secretCard = document.getElementById("secretCard");
  const holdBtn = document.getElementById("holdBtn");
  let holding = false;
  let holdTimer = null;
  const HOLD_MS = 220;

  function revealOn(){ secretCard.classList.add("revealed"); }
  function revealOff(){
    secretCard.classList.remove("revealed");
    nextBtn.disabled = false;
    nextBtn.removeAttribute("disabled");
  }
  function startHold(e){
    e.preventDefault();
    holding = true;
    clearTimeout(holdTimer);
    holdTimer = setTimeout(() => { if(holding) revealOn(); }, HOLD_MS);
  }
  function endHold(e){
    if(e) e.preventDefault();
    holding = false;
    clearTimeout(holdTimer);
    revealOff();
  }

  holdBtn.addEventListener("pointerdown", startHold);
  holdBtn.addEventListener("pointerup", endHold);
  holdBtn.addEventListener("pointercancel", endHold);
  holdBtn.addEventListener("pointerleave", endHold);

  holdBtn.addEventListener("keydown", (e) => {
    if(e.code === "Space" || e.code === "Enter"){ startHold(e); }
  });
  holdBtn.addEventListener("keyup", (e) => {
    if(e.code === "Space" || e.code === "Enter"){ endHold(e); }
  });

  // try fullscreen on first meaningful touch (Android)
  stage.addEventListener("pointerdown", () => {
    if(!isIOS() && !document.fullscreenElement){
      requestFullscreenSafe();
    }
  }, { once:true });
}

function renderBriefing(){
  clearStage();

  const imp = getAliveImpostors().length;
  const civ = getAliveCivilians().length;

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Listos para jugar"]),
    el("p",{},[
      "Ahora conversen por turnos. Cada jugador dice una pista relacionada con la palabra, sin decirla literalmente. "
    ]),
    el("div",{class:"help"},[
      "Sugerencia: hagan 2‚Äì3 vueltas de pistas antes de votar para que sea m√°s divertido."
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Resumen (solo para el anfitri√≥n)"]),
      el("div",{class:"mut"},[
        `Civiles: ${civ}. Impostores: ${imp}. Votaciones disponibles: ${state.votesLeftThisGame}.`
      ])
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => {
        // restart same setup
        state.revealIndex = 0;
        state.secretWord = pickSecretWord();
        assignRoles();
        setStep("reveal");
      }},["‚Üª Repartir otra palabra"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => beginVotingCycle()},["üó≥ Empezar votaci√≥n"])
    ])
  ]);

  stage.appendChild(panel);
}

function renderVoteTurn(){
  clearStage();

  const alive = getAlivePlayers();
  if(alive.length < 2){
    state.finished = true;
    state.winner = "civiles";
    return setStep("end");
  }

  // Find next voter who is alive and hasn't voted
  let voter = null;
  for(let i=0; i<state.players.length; i++){
    const p = state.players[(state.voterIndex + i) % state.players.length];
    if(p.alive && !state.votedBy.has(p.id)){
      voter = p;
      state.voterIndex = (state.players.indexOf(p) + 1) % state.players.length;
      break;
    }
  }
  if(!voter){
    // all votes collected
    return setStep("vote_result");
  }

  const suspects = alive.filter(p => p.id !== voter.id);

  const panel = el("div",{class:"panel"},[
    el("h2",{},[`Votaci√≥n ${state.votesUsed+1} de ${state.votesLeftThisGame}`]),
    el("p",{},[
      "Pasa el tel√©fono a ",
      el("b",{},[voter.name]),
      ". Solo esa persona debe votar."
    ]),
    el("div",{class:"help"},["Selecciona a qui√©n consideras impostor y confirma."])
  ]);

  const list = el("div",{class:"playersList"});
  const group = "vote_"+voter.id;

  for(const s of suspects){
    const rid = `${group}_${s.id}`;
    list.appendChild(el("div",{class:"voteItem"},[
      el("div",{},[
        el("div",{class:"nm"},[s.name]),
        el("small",{},["Toca para seleccionar"])
      ]),
      el("input",{class:"radio",type:"radio",name:group,id:rid,value:s.id})
    ]));
  }

  const btn = el("button",{class:"btn btn-primary",type:"button","data-next-primary":"1"},["Confirmar voto"]);

  btn.addEventListener("click", () => {
    const selected = panel.querySelector(`input[name="${group}"]:checked`);
    if(!selected){
      toast("Selecciona un jugador para votar.", true);
      return;
    }
    const suspectId = selected.value;
    state.votedBy.add(voter.id);
    state.votes.set(suspectId, (state.votes.get(suspectId)||0) + 1);
    toast("Voto registrado.", false);

    // move to next voter
    setTimeout(() => setStep("vote_turn"), 250);
  });

  panel.appendChild(list);
  panel.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => { state.votesUsed = Math.max(0, state.votesUsed-1); setStep("briefing"); }},["‚¨Ö Volver a pistas"]),
    btn
  ]));

  stage.appendChild(panel);

  stage.addEventListener("pointerdown", () => {
    if(!isIOS() && !document.fullscreenElement){
      requestFullscreenSafe();
    }
  }, { once:true });
}

function renderVoteResult(){
  clearStage();

  const eliminatedId = tallyVotes();
  if(!eliminatedId){
    toast("No se pudo calcular la votaci√≥n.", true);
    return setStep("briefing");
  }
  eliminatePlayer(eliminatedId);

  state.votesUsed += 1;

  const eliminated = state.players.find(p => p.id === eliminatedId);
  const wasImp = eliminated?.role === "impostor";

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Resultado de votaci√≥n"]),
    el("p",{},[
      "Eliminado: ",
      el("b",{},[eliminated?.name || "‚Äî"]),
      "."
    ]),
    el("div",{class: wasImp ? "ok" : "warn"},[
      wasImp ? "Era IMPOSTOR." : "No era impostor."
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Conteo de votos (anfitri√≥n)"]),
      el("div",{class:"mut"},[
        ...getAlivePlayers().map(p => `${p.name}: ${state.votes.get(p.id)||0}  `)
      ])
    ])
  ]);

  // reset voting maps for next vote or next round
  state.votes = new Map();
  state.votedBy = new Set();

  // award coins at the end of each vote round (treat as completing a round)
  awardRoundCoins();

  // Check immediate win
  if(checkWinAfterVote()){
    panel.appendChild(el("div",{class:"row"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => setStep("end")},["Ver resultado final"])
    ]));
    stage.appendChild(panel);
    return;
  }

  // If still ongoing: allow impostors to guess now (as requested)
  panel.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => setStep("briefing")},["Volver a pistas"]),
    el("button",{class:"btn btn-primary",type:"button",onclick:() => beginImpostorGuessing()},["üß† Impostores: adivinar palabra"])
  ]));

  stage.appendChild(panel);
}

function renderGuessTurn(){
  clearStage();

  const aliveImps = getAliveImpostors();
  if(aliveImps.length === 0){
    state.finished = true;
    state.winner = "civiles";
    return setStep("end");
  }

  const idList = aliveImps.map(p => p.id);
  state.aliveImpostorIds = idList;

  const impId = state.aliveImpostorIds[state.guessIndex];
  const imp = state.players.find(p => p.id === impId);

  if(!imp){
    // no more impostors to ask
    return setStep("guess_result");
  }

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Adivinar palabra (solo impostor)"]),
    el("p",{},[
      "Pasa el tel√©fono a ",
      el("b",{},[imp.name]),
      ". Escribe tu intento de palabra. Si aciertas, ganas."
    ]),
    el("label",{for:"guess"},["Tu palabra (exacta)"]),
    el("input",{id:"guess",type:"text",placeholder:"Escribe aqu√≠",autocomplete:"off",autocapitalize:"none"}),
    el("div",{class:"help"},["Consejo: escribe tal cual crees que es la palabra. Se ignoran tildes y may√∫sculas."])
  ]);

  const btn = el("button",{class:"btn btn-primary",type:"button"},["Confirmar intento"]);
  btn.addEventListener("click", () => {
    const g = (document.getElementById("guess").value||"").trim();
    if(!g){
      toast("Escribe una palabra.", true);
      return;
    }
    state.impostorGuesses.set(imp.id, g);
    toast("Intento guardado.", false);

    state.guessIndex += 1;
    if(state.guessIndex >= state.aliveImpostorIds.length){
      setStep("guess_result");
    }else{
      setStep("guess_turn");
    }
  });

  panel.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => setStep("briefing")},["‚¨Ö Cancelar"]),
    btn
  ]));

  stage.appendChild(panel);
}

function renderGuessResult(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Resultado de intento"]),
  ]);

  if(checkImpostorGuessWin()){
    panel.appendChild(el("div",{class:"ok"},["Un impostor acert√≥ la palabra."]));
    panel.appendChild(el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Palabra real"]),
      el("div",{class:"mut"},[state.secretWord])
    ]));
    panel.appendChild(el("div",{class:"row"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => setStep("end")},["Ver resultado final"])
    ]));
    stage.appendChild(panel);
    return;
  }

  panel.appendChild(el("div",{class:"warn"},["Ning√∫n impostor acert√≥."]));
  panel.appendChild(el("div",{class:"help"},[
    `Votos restantes: ${Math.max(0, state.votesLeftThisGame - state.votesUsed)}.`
  ]));

  // If no more votes, civilians win (impostors couldn't guess) OR impostors win (survived)
  if(checkWinAfterVote()){
    panel.appendChild(el("div",{class:"row"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => setStep("end")},["Ver resultado final"])
    ]));
    stage.appendChild(panel);
    return;
  }

  // Otherwise continue discussion then next vote when ready
  panel.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => setStep("briefing")},["Volver a pistas"]),
    el("button",{class:"btn btn-primary",type:"button",onclick:() => beginVotingCycle()},["üó≥ Siguiente votaci√≥n"])
  ]));

  stage.appendChild(panel);
}

function renderEnd(){
  clearStage();

  const title = state.winner === "impostores" ? "Ganaron los impostores" : "Ganaron los civiles";
  const icon  = state.winner === "impostores" ? "üïµÔ∏è‚Äç‚ôÇÔ∏è" : "üõ°Ô∏è";
  const color = state.winner === "impostores" ? "var(--bad)" : "var(--good)";

  const imps = state.players.filter(p => p.role === "impostor");
  const civs = state.players.filter(p => p.role === "civil");

  const panel = el("div",{class:"panel"},[
    el("h2",{},[`${icon} ${title}`]),
    el("p",{},[
      "Palabra de la ronda: ",
      el("b",{},[state.secretWord]),
      "."
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl",style:`color:${color}`},["Roles"]),
      el("div",{class:"mut"},[
        "Impostores: " + (imps.map(p=>p.name).join(", ") || "‚Äî"),
        " ¬∑ Civiles: " + (civs.map(p=>p.name).join(", ") || "‚Äî")
      ])
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Monedas acumuladas"]),
      el("div",{class:"mut"},[
        ...state.players.map(p => `${p.name}: ${(p.coins||0)}  `)
      ])
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => {
        // new round with same players & impostor count, keep coins
        state.round += 1;
        state.votesUsed = 0;
        state.votesLeftThisGame = state.impostorCount;
        state.revealIndex = 0;
        state.secretWord = pickSecretWord();
        assignRoles();
        state.finished = false;
        state.winner = "";
        setStep("reveal");
      }},["‚ñ∂ Siguiente ronda"]),
      el("button",{class:"btn btn-danger",type:"button",onclick:() => {
        // reset everything
        state.playerCount = 4;
        state.players = [];
        state.impostorCount = 1;
        state.round = 0;
        state.votesLeftThisGame = 0;
        state.votesUsed = 0;
        state.revealIndex = 0;
        state.secretWord = "";
        state.usedWords = new Set();
        state.wordBank = shuffle(buildWordBank());
        updateHUD();
        setStep("home");
      }},["‚ü≤ Reiniciar todo"])
    ]),
    el("div",{class:"help"},[
      "Nota: si hay empate en la votaci√≥n, el eliminado se decide aleatoriamente entre los empatados (para mantener la partida fluida)."
    ])
  ]);

  stage.appendChild(panel);
}

/* boot */
setStep("home");

})();
</script>
</body>
</html>
