<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Impostor ¬∑ Vertical Pro</title>

  <style>
    :root{
      --bg0:#05060d;
      --bg1:#0b1020;
      --bg2:#020617;

      --panel: rgba(15, 23, 42, 0.84);
      --panel2: rgba(2, 6, 23, 0.58);
      --stroke: rgba(148, 163, 184, 0.20);

      --text:#f8fafc;
      --muted:#cbd5f5;

      --cyan:#22d3ee;
      --violet:#a78bfa;
      --pink:#fb7185;
      --lime:#34d399;
      --amber:#fbbf24;

      --good:#22c55e;
      --bad:#fb7185;

      --shadow: 0 28px 80px rgba(0,0,0,.52), inset 0 1px 0 rgba(255,255,255,0.06);
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body{ height:100%; width:100%; }

    body{
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      color:var(--text);
      padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(14px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      overflow:hidden;
      touch-action: manipulation;
      -webkit-user-select:none;
      user-select:none;

      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(900px 520px at 85% 18%, rgba(167,139,250,0.22), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(251,191,36,0.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    #app{ width:100%; display:flex; justify-content:center; }

    .shell{
      width: min(720px, 100%);
      background: linear-gradient(180deg, var(--panel), rgba(15,23,42,0.68));
      border:1px solid var(--stroke);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      display:flex;
      flex-direction:column;
      min-height: calc(100dvh - 24px);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(148,163,184,0.16);
      position:sticky;
      top:0;
      z-index:10;
      background: linear-gradient(180deg, rgba(2,6,23,0.35), rgba(2,6,23,0.08));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:42px; height:42px; border-radius:16px;
      display:grid; place-items:center;
      background: radial-gradient(20px 20px at 30% 30%, rgba(255,255,255,0.14), transparent 60%),
                  linear-gradient(135deg, rgba(34,211,238,0.92), rgba(167,139,250,0.92));
      border:1px solid rgba(255,255,255,0.16);
      box-shadow: 0 16px 40px rgba(0,0,0,0.35);
      font-size:22px;
      flex: 0 0 auto;
    }
    .brand h1{
      font-size: 14px;
      font-weight: 1100;
      letter-spacing:.2px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin-top:2px;
      font-size: 12px;
      color: rgba(203,213,245,0.92);
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .hud{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(2,6,23,0.44);
      border:1px solid rgba(148,163,184,0.18);
      font-size: 12px;
      font-weight: 950;
      color: rgba(248,250,252,0.96);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .chip b{ font-weight: 1200; }

    main{
      position:relative;
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 14px;
    }

    .panel{
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
      border-radius: 22px;
      padding: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }

    h2{
      font-size: 18px;
      font-weight: 1200;
      letter-spacing:.2px;
      margin-bottom: 8px;
    }
    p{ font-size: 13px; font-weight: 850; color: rgba(203,213,245,0.92); line-height:1.35; }
    .help{ margin-top:8px; font-size:12px; color: rgba(203,213,245,0.88); font-weight:800; }
    .warn{ margin-top:10px; font-size:12px; color: rgba(251,113,133,0.98); font-weight:950; }
    .ok{ margin-top:10px; font-size:12px; color: rgba(34,197,94,0.98); font-weight:950; }

    label{
      display:block;
      font-size:12px;
      font-weight: 1100;
      letter-spacing:.2px;
      color: rgba(248,250,252,0.96);
      margin: 10px 0 6px;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(2,6,23,0.42);
      border:1px solid rgba(148,163,184,0.22);
      color: rgba(248,250,252,0.98);
      outline:none;
      font-size:14px;
      font-weight: 950;
    }
    input::placeholder{ color: rgba(203,213,245,0.55); font-weight:800; }

    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:12px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:520px){
      .grid2{ grid-template-columns:1fr 1fr; }
      .brand h1{ font-size:15px; }
    }

    .btn{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.44);
      color: rgba(248,250,252,0.98);
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 1100;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .08s ease;
    }
    .btn:active{ transform: translateY(1px); filter: brightness(1.04); }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; }

    .btn-primary{
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(167,139,250,0.92));
      box-shadow: 0 16px 44px rgba(0,0,0,0.35);
    }
    .btn-danger{
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(251,113,133,0.98), rgba(251,191,36,0.74));
    }

    /* Toast */
    #toast{
      position:fixed;
      left:50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(2,6,23,0.86);
      border:1px solid rgba(148,163,184,0.22);
      color: rgba(248,250,252,0.98);
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 950;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 999;
      max-width: min(520px, 92vw);
    }
    #toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
    #toast.bad{ border-color: rgba(251,113,133,0.45); }
    #toast.good{ border-color: rgba(34,197,94,0.45); }

    /* iOS Hint */
    #iosHint{
      margin-top:12px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
      display:none;
    }
    #iosHint .row{ margin-top:0; }
    #iosHint .ttl{ font-weight:1200; font-size:13px; }
    #iosHint .mut{ font-weight:850; font-size:12px; color: rgba(203,213,245,0.92); line-height:1.35; }
    #iosHint .x{
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(2,6,23,0.44);
      color: rgba(248,250,252,0.98);
      padding: 8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:1100;
    }

    /* Secret Card (Vertical first) */
    .revealWrap{ display:flex; flex-direction:column; gap:12px; align-items:stretch; margin-top:10px; }
    .secretCard{
      position:relative;
      width:100%;
      border-radius: 26px;
      padding: 14px 14px 16px;
      background:
        radial-gradient(520px 240px at 25% 18%, rgba(34,211,238,0.22), transparent 60%),
        radial-gradient(520px 240px at 80% 30%, rgba(167,139,250,0.20), transparent 60%),
        rgba(2,6,23,0.54);
      border:1px solid rgba(148,163,184,0.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 16px 50px rgba(0,0,0,0.45);
      overflow:hidden;
    }
    .secretHeader{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 8px 0 6px;
      text-align:center;
    }
    .avatarIcon{
      width:58px; height:58px;
      border-radius: 22px;
      display:grid; place-items:center;
      background: radial-gradient(22px 22px at 28% 28%, rgba(255,255,255,0.16), transparent 60%),
                  linear-gradient(135deg, rgba(251,191,36,0.92), rgba(251,113,133,0.92));
      border:1px solid rgba(255,255,255,0.18);
      box-shadow: 0 16px 46px rgba(0,0,0,0.35);
      font-size: 26px;
    }
    .playerName{
      font-size: 18px;
      font-weight: 1250;
      letter-spacing:.2px;
      color: rgba(248,250,252,0.98);
    }

    .secretCard .role{
      margin-top:8px;
      text-align:center;
      font-size: 14px;
      font-weight: 1200;
      letter-spacing:.4px;
    }
    .secretCard .word{
      text-align:center;
      font-size: 34px;
      font-weight: 1300;
      letter-spacing: .6px;
      margin-top: 10px;
      text-transform: uppercase;
    }

    .secretCard .mask{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      background:
        radial-gradient(520px 260px at 28% 22%, rgba(34,211,238,0.18), transparent 62%),
        radial-gradient(520px 260px at 80% 34%, rgba(167,139,250,0.18), transparent 62%),
        rgba(0,0,0,0.70);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: opacity .12s ease;
    }
    .secretCard.revealed .mask{ opacity:0; pointer-events:none; }
    .maskInner{
      width:100%;
      border-radius: 22px;
      padding: 12px 12px;
      background: rgba(2,6,23,0.58);
      border:1px solid rgba(148,163,184,0.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      text-align:center;
    }
    .maskInner h3{ font-size: 14px; font-weight: 1250; margin-bottom:6px; }
    .maskInner p{ margin:0; font-size: 12px; font-weight: 850; color: rgba(203,213,245,0.92); }
    .holdBtn{
      margin-top: 10px;
      width:100%;
      padding: 14px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(135deg, rgba(34,211,238,0.95), rgba(167,139,250,0.92));
      color: rgba(248,250,252,0.98);
      font-size: 14px;
      font-weight: 1200;
      cursor:pointer;
      user-select:none;
      touch-action:none;
    }
    .holdBtn:active{ filter: brightness(1.04); transform: translateY(1px); }

    .bottomNext{
      margin-top: 10px;
      width:100%;
      padding: 14px 12px;
      border-radius: 18px;
      font-size: 14px;
      font-weight: 1200;
    }

    /* Voting list */
    .playersList{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .voteItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(2,6,23,0.38);
      border:1px solid rgba(148,163,184,0.18);
    }
    .voteItem .nm{ font-weight: 1150; font-size: 14px; letter-spacing:.2px; }
    .voteItem small{ color: rgba(203,213,245,0.88); font-weight: 850; font-size: 12px; }
    .radio{ width:22px; height:22px; accent-color: #22d3ee; cursor:pointer; }

    /* End summary cards */
    .resultCard{
      margin-top: 12px;
      border-radius: 22px;
      padding: 12px 12px;
      background: rgba(2,6,23,0.46);
      border:1px solid rgba(148,163,184,0.18);
    }
    .resultCard .ttl{ font-weight:1200; font-size: 14px; margin-bottom:6px; }
    .resultCard .mut{ font-weight:850; font-size: 12px; color: rgba(203,213,245,0.92); }

    .row-center{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:12px; }

    /* Fullscreen gate (for browsers that require a user gesture) */
    #fsGate{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 9999;
    }
    #fsGate .box{
      width: min(520px, 92vw);
      border-radius: 26px;
      padding: 16px 16px;
      background: rgba(2,6,23,0.82);
      border:1px solid rgba(148,163,184,0.22);
      box-shadow: 0 28px 90px rgba(0,0,0,0.58);
      text-align:center;
    }
    #fsGate .box h3{
      font-size: 16px;
      font-weight: 1250;
      margin-bottom: 8px;
      letter-spacing:.2px;
    }
    #fsGate .box p{
      font-size: 12px;
      font-weight: 900;
      color: rgba(203,213,245,0.92);
      line-height:1.35;
    }

  </style>
</head>

<body>
  <div id="app">
    <div class="shell">
      <header>
        <div class="brand" aria-label="Encabezado del juego">
          <div class="logo" aria-hidden="true">üïµÔ∏è</div>
          <div style="min-width:0">
            <h1>Impostor</h1>
            <p>Vertical ¬∑ tarjetas privadas ¬∑ votaciones</p>
          </div>
        </div>
        <div class="hud" aria-label="Indicadores">
          <div class="chip">ü™ô <b id="hudCoins">0</b></div>
          <div class="chip">üé≤ Ronda <b id="hudRound">0</b></div>
          <div class="chip">üó≥ Votos <b id="hudVotesLeft">0</b></div>
        </div>
      </header>

      <main id="stage" aria-live="polite"></main>
    </div>
  </div>

  <!-- Fullscreen Gate -->
  <div id="fsGate" aria-hidden="true">
    <div class="box">
      <h3>Pantalla completa</h3>
      <p>Tu navegador requiere un toque para activar pantalla completa.</p>
      <div class="row-center" style="margin-top:12px">
        <button id="fsBtn" class="btn btn-primary" type="button">Entrar a pantalla completa</button>
      </div>
      <div class="help" style="margin-top:10px">Si est√°s en iPhone, usa ‚ÄúCompartir ‚Üí A√±adir a pantalla de inicio‚Äù.</div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
"use strict";

/* =========================================================
 *  Safety: show any runtime error on screen (so it never looks "blank")
 * ========================================================= */
window.addEventListener("error", (e) => {
  try{
    const msg = (e && (e.message || e.error?.message)) ? (e.message || e.error.message) : "Error desconocido";
    const where = e?.filename ? `\n${e.filename}:${e.lineno||""}:${e.colno||""}` : "";
    const box = document.createElement("div");
    box.className = "panel";
    box.innerHTML = `
      <h2 style="color:rgba(251,113,133,0.98)">Error detectado</h2>
      <p style="color:rgba(248,250,252,0.95);font-weight:950;margin-top:8px">El juego se detuvo por un error de JavaScript.</p>
      <div class="warn" style="white-space:pre-wrap;margin-top:10px">${msg}${where}</div>
      <div class="help" style="margin-top:10px">Soluci√≥n r√°pida: recarga la p√°gina. Si persiste, env√≠ame esta captura.</div>
    `;
    const st = document.getElementById("stage");
    if(st){ st.innerHTML=""; st.appendChild(box); }
  }catch(_){}
});
window.addEventListener("unhandledrejection", (e) => {
  try{
    const msg = (e && e.reason) ? (e.reason.message || String(e.reason)) : "Promesa rechazada";
    const st = document.getElementById("stage");
    if(st){
      const box = document.createElement("div");
      box.className = "panel";
      box.innerHTML = `
        <h2 style="color:rgba(251,113,133,0.98)">Error detectado</h2>
        <div class="warn" style="white-space:pre-wrap;margin-top:10px">${msg}</div>
      `;
      st.innerHTML=""; st.appendChild(box);
    }
  }catch(_){}
});



/* =========================================================
 *  Fullscreen & iOS app-like mode
 *  - Most browsers require a user gesture to enter fullscreen.
 *  - We try on load; if blocked, we show a single-tap gate.
 * ========================================================= */
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}
function isStandalone(){
  return (window.navigator.standalone === true) || window.matchMedia("(display-mode: standalone)").matches;
}
async function requestFullscreenSafe(){
  const el = document.documentElement;
  try{
    if(document.fullscreenElement) return true;
    if(el.requestFullscreen) { await el.requestFullscreen(); }
    else if(el.webkitRequestFullscreen) { await el.webkitRequestFullscreen(); }
    return !!document.fullscreenElement;
  }catch(_){
    return false;
  }
}
const iosHint = document.getElementById("iosHint") || document.createElement("div");
iosHint.id = "iosHint";

function showIOSHint(){
  const hint = document.getElementById("iosHint");
  if(!hint) return;
  const isMobile = Math.min(window.innerWidth, window.innerHeight) <= 900;
  if(isIOS() && isMobile && !isStandalone()){
    hint.style.display = "block";
    hint.innerHTML = `
      <div class="row">
        <div style="min-width:0">
          <div class="ttl">iPhone (Safari)</div>
          <div class="mut">Para verlo tipo app (sin barras): <b>Compartir ‚Üí A√±adir a pantalla de inicio</b> y √°brelo desde ah√≠.</div>
        </div>
        <button class="x" type="button" aria-label="Cerrar">‚úï</button>
      </div>
    `;
    hint.querySelector(".x")?.addEventListener("click", () => (hint.style.display = "none"), { once:true });
  } else {
    hint.style.display = "none";
  }
}
showIOSHint();
window.addEventListener("resize", showIOSHint);
window.visualViewport?.addEventListener("resize", showIOSHint);

const fsGate = document.getElementById("fsGate");
const fsBtn  = document.getElementById("fsBtn");

function hideFSGate(){ if(!fsGate) return; fsGate.style.display = "none"; fsGate.setAttribute("aria-hidden","true"); }
function showFSGate(){ if(!fsGate) return; fsGate.style.display = "flex"; fsGate.setAttribute("aria-hidden","false"); }

fsBtn?.addEventListener("click", async () => {
  const ok = await requestFullscreenSafe();
  if(ok) hideFSGate();
});

/* Try to enter fullscreen immediately (may be blocked). */
(async () => {
  if(isIOS()) { hideFSGate(); return; }
  await requestFullscreenSafe();
  setTimeout(() => {
    if(!document.fullscreenElement){
      showFSGate();
    } else {
      hideFSGate();
    }
  }, 200);
})();

/* Also attempt fullscreen on the first user interaction anywhere */
window.addEventListener("pointerdown", async () => {
  if(isIOS()) return;
  if(document.fullscreenElement) { hideFSGate(); return; }
  const ok = await requestFullscreenSafe();
  if(ok) hideFSGate();
}, { once:true });

/* =========================================================
 *  Toast + DOM helpers
 * ========================================================= */
const stage = document.getElementById("stage");
const toastEl = document.getElementById("toast");

function el(tag, attrs={}, children=[]){
  const n = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k === "class") n.className = v;
    else if(k === "style") n.setAttribute("style", v);
    else if(k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  }
  for(const c of (children||[])){
    if(c === null || c === undefined) continue;
    if(typeof c === "string") n.appendChild(document.createTextNode(c));
    else n.appendChild(c);
  }
  return n;
}

let toastTimer = null;
function toast(msg, bad=false){
  toastEl.textContent = msg;
  toastEl.className = "";
  toastEl.classList.add("show");
  toastEl.classList.add(bad ? "bad" : "good");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1700);
}

function clearStage(){ stage.innerHTML = ""; }

function norm(s){
  return (s||"")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

/* =========================================================
 *  Word bank (SINGLE WORDS ONLY, >1000)
 *  - No phrases, no spaces.
 *  - Expand base nouns with plural + diminutive + augmentative.
 * ========================================================= */
const BASE_WORDS = [
  "gelatina","silla","medias","helado","perro","mantequilla","barco","carro","cielo","amarillo",
  "gato","conejo","tortuga","caballo","vaca","oveja","zorro","lobo","oso","tigre","leon","delfin","tiburon","pulpo",
  "manzana","pera","mango","pi√±a","papaya","fresa","sandia","naranja","limon","uva","banano","cereza","durazno","guayaba",
  "tomate","cebolla","ajo","papa","yuca","zanahoria","pepino","lechuga","brocoli","espinaca","maiz","arroz","pasta","lenteja","frijol",
  "pan","queso","huevo","pollo","carne","pescado","atun","sopa","ensalada","pizza","taco","arepa","empanada","tamal",
  "cafe","te","jugo","agua","leche","yogur","miel","azucar","sal","pimienta",
  "mesa","ventana","puerta","llave","candado","cortina","espejo","alfombra","lampara","reloj","cama","almohada","cobija","armario","cajon",
  "libro","cuaderno","lapiz","boligrafo","borrador","mochila","maleta","cargador","audifonos","celular","tablet","computador","teclado","mouse",
  "camara","bateria","parlante","microfono","cable","enchufe","bombillo","ventilador","nevera","estufa","horno","licuadora","cafetera",
  "plato","vaso","taza","cuchara","tenedor","cuchillo","olla","sarten","espatula","colador","termo","servilleta","bolsa","caja","frasco",
  "calle","puente","tunel","estacion","aeropuerto","playa","monta√±a","bosque","selva","rio","cascada","lago","isla","volcan","cueva",
  "sol","luna","estrella","nube","viento","lluvia","trueno","relampago","nieve","hielo","fuego","arena","roca","madera","flor","semilla",
  "camisa","pantalon","zapato","media","gorra","sombrero","chaqueta","reloj","anillo","collar","bolso",
  "balon","futbol","tenis","voleibol","natacion","ciclismo","ajedrez","dardos","bolos",
  "rojo","azul","verde","negro","blanco","morado","naranja","rosa","gris","cafe","dorado","plateado",
  "dinero","moneda","billete","tarjeta","banco","ahorro",
  "doctor","policia","bombero","cocinero","panadero","barbero","mecanico","piloto","arquitecto","musico","cantante","actor",
  "robot","dron","sensor","gps","internet","correo","mensaje","chat","perfil"
];

function pluralize(w){
  if(w.endsWith("s")) return w;          // already plural-ish
  if(w.endsWith("z")) return w.slice(0,-1) + "ces";
  if(/[aeiou]$/.test(w)) return w + "s";
  return w + "es";
}
function diminutive(w){
  // simple Spanish diminutive; best-effort
  if(w.length < 3) return w;
  if(w.endsWith("a")) return w.slice(0,-1) + "ita";
  if(w.endsWith("o")) return w.slice(0,-1) + "ito";
  if(w.endsWith("e")) return w.slice(0,-1) + "ecito";
  return w + "cito";
}
function augmentative(w){
  if(w.length < 3) return w;
  if(w.endsWith("a")) return w.slice(0,-1) + "ona";
  if(w.endsWith("o")) return w.slice(0,-1) + "on";
  return w + "on";
}
function buildWordBank(){
  const set = new Set();
  for(const w of BASE_WORDS){
    const clean = norm(w).replace(/\s+/g,"");
    if(!clean) continue;
    set.add(clean);
    set.add(pluralize(clean));
    set.add(diminutive(clean));
    set.add(augmentative(clean));
  }
  // If still under 1100, expand with additional safe variants
  const arr = Array.from(set);
  if(arr.length < 1100){
    for(const w of arr.slice(0, 400)){
      set.add(w + "s"); // extra plural safety
      set.add(w + "ito");
      set.add(w + "azo");
    }
  }
  return Array.from(set);
}

function shuffle(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* =========================================================
 *  State
 * ========================================================= */
const hudCoins = document.getElementById("hudCoins");
const hudRound = document.getElementById("hudRound");
const hudVotesLeft = document.getElementById("hudVotesLeft");

const state = {
  step: "home",
  playerCount: 4,
  players: [], // {id,name,role,alive,coins}
  impostorCount: 1,

  // betting
  betEnabled: false,
  betAmount: 0,

  // round
  round: 0,
  votesAllowed: 0,
  votesUsed: 0,

  // reveal
  revealIndex: 0,

  // words
  wordBank: shuffle(buildWordBank()),
  usedWords: new Set(),
  secretWord: "",

  // voting flow (combined: civilians vote, impostors guess)
  turnIndex: 0,
  votes: new Map(),          // suspectId -> count
  impostorGuesses: new Map(),// impostorId -> guess

  finished: false,
  winner: ""
};

function getAlivePlayers(){ return state.players.filter(p => p.alive); }
function getAliveImpostors(){ return state.players.filter(p => p.alive && p.role === "impostor"); }
function getAliveCivilians(){ return state.players.filter(p => p.alive && p.role === "civil"); }

function updateHUD(){
  const totalCoins = state.players.reduce((a,p) => a + (p.coins||0), 0);
  hudCoins.textContent = String(totalCoins);
  hudRound.textContent = String(state.round);
  const left = Math.max(0, state.votesAllowed - state.votesUsed);
  hudVotesLeft.textContent = String(left);
}

function setStep(step){
  state.step = step;
  render();
}

function pickSecretWord(){
  const bank = state.wordBank;
  for(let tries=0; tries < bank.length; tries++){
    const w = bank.shift();
    bank.push(w);
    const key = norm(w);
    if(!state.usedWords.has(key)){
      state.usedWords.add(key);
      return w;
    }
  }
  return bank[Math.floor(Math.random()*bank.length)];
}

function assignRoles(){
  for(const p of state.players){
    p.role = "civil";
    p.alive = true;
  }
  const ids = state.players.map(p => p.id);
  shuffle(ids);
  const chosen = new Set(ids.slice(0, state.impostorCount));
  for(const p of state.players){
    if(chosen.has(p.id)) p.role = "impostor";
  }
}

function startNewGame(){
  state.finished = false;
  state.winner = "";

  state.round = Math.max(1, state.round + 1);
  state.votesAllowed = state.impostorCount; // your rule
  state.votesUsed = 0;

  state.revealIndex = 0;

  state.secretWord = pickSecretWord();
  assignRoles();

  state.turnIndex = 0;
  state.votes = new Map();
  state.impostorGuesses = new Map();

  updateHUD();
  setStep("reveal");
}

function awardRoundCoins(){
  for(const p of state.players){
    p.coins = (p.coins||0) + 2;
  }
  updateHUD();
}

function computePot(){
  if(!state.betEnabled) return 0;
  const amt = Number(state.betAmount||0);
  if(!Number.isFinite(amt) || amt <= 0) return 0;
  return amt * state.playerCount;
}

/* winner checks */
function checkWinnerByRoles(){
  const imps = getAliveImpostors().length;
  const civs = getAliveCivilians().length;
  if(imps === 0){
    state.finished = true;
    state.winner = "civiles";
    return true;
  }
  if(civs === 0){
    state.finished = true;
    state.winner = "impostores";
    return true;
  }
  return false;
}
function checkImpostorGuessWin(){
  const secret = norm(state.secretWord);
  for(const imp of getAliveImpostors()){
    const g = state.impostorGuesses.get(imp.id);
    if(g && norm(g) === secret){
      state.finished = true;
      state.winner = "impostores";
      return true;
    }
  }
  return false;
}

/* vote tally and elimination */
function tallyVotes(){
  const alive = getAlivePlayers();
  let max = 0;
  let top = [];
  for(const p of alive){
    const c = state.votes.get(p.id) || 0;
    if(c > max){
      max = c;
      top = [p.id];
    } else if(c === max && c > 0){
      top.push(p.id);
    }
  }
  if(max === 0){
    return alive[Math.floor(Math.random()*alive.length)].id;
  }
  return top[Math.floor(Math.random()*top.length)];
}
function eliminatePlayer(id){
  const p = state.players.find(x => x.id === id);
  if(p) p.alive = false;
}

/* =========================================================
 *  Renderers
 * ========================================================= */
function render(){
  updateHUD();
  switch(state.step){
    case "home": return renderHome();
    case "setup_count": return renderSetupCount();
    case "setup_names": return renderSetupNames();
    case "setup_impostors": return renderSetupImpostors();
    case "reveal": return renderReveal();
    case "briefing": return renderBriefing();
    case "turn": return renderTurn();            // combined: civilians vote, impostors guess
    case "vote_result": return renderVoteResult();
    case "end": return renderEnd();
    default: return renderHome();
  }
}

function renderHome(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Configurar partida"]),
    el("p",{},["Juego local para pasar el tel√©fono. Tarjetas privadas, luego votaci√≥n. El impostor no vota: solo intenta adivinar la palabra."]),
    iosHint,
    el("div",{class:"row-center"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => setStep("setup_count")},["‚ñ∂ Empezar"])
    ]),
    el("div",{class:"help"},["Si no entra a pantalla completa al abrir, toca el bot√≥n de ‚ÄúPantalla completa‚Äù que aparece encima."])
  ]);

  stage.appendChild(panel);
}

function renderSetupCount(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Jugadores y apuesta"]),
    el("p",{},["Define cu√°ntos jugadores van a jugar y si la ronda ser√° con apuesta o sin apuesta."]),
    el("label",{for:"pc"},["Cantidad de jugadores (3‚Äì20)"]),
    el("input",{id:"pc",type:"number",min:"3",max:"20",inputmode:"numeric",value:String(state.playerCount)}),

    el("label",{for:"betMode"},["Modo de juego"]),
    el("select",{id:"betMode"},[
      el("option",{value:"no"},["Sin apuesta"]),
      el("option",{value:"yes"},["Con apuesta"])
    ]),
    el("div",{id:"betBox",style:"display:none"},[
      el("label",{for:"betAmt"},["Valor de la apuesta (por persona)"]),
      el("input",{id:"betAmt",type:"number",min:"1",step:"1",inputmode:"numeric",placeholder:"Ej: 5000"}),
      el("div",{class:"help"},["Regla: todos deben poner en la mesa la cantidad seleccionada antes de empezar."])
    ]),

    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => setStep("home")},["‚¨Ö Volver"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        const v = Math.floor(Number(document.getElementById("pc").value||0));
        if(!Number.isFinite(v) || v < 3 || v > 20){
          toast("Ingresa un n√∫mero entre 3 y 20.", true);
          return;
        }

        const mode = document.getElementById("betMode").value;
        if(mode === "yes"){
          const amt = Math.floor(Number(document.getElementById("betAmt").value||0));
          if(!Number.isFinite(amt) || amt <= 0){
            toast("Ingresa un valor v√°lido para la apuesta.", true);
            return;
          }
          state.betEnabled = true;
          state.betAmount = amt;
        } else {
          state.betEnabled = false;
          state.betAmount = 0;
        }

        state.playerCount = v;
        state.players = Array.from({length:v}).map((_,i)=>({
          id: "p"+(i+1),
          name: "",
          role:"civil",
          alive:true,
          coins: state.players[i]?.coins || 0
        }));
        setStep("setup_names");
      }},["Siguiente"])
    ])
  ]);

  stage.appendChild(panel);

  // init select
  const betMode = document.getElementById("betMode");
  const betBox = document.getElementById("betBox");
  betMode.value = state.betEnabled ? "yes" : "no";
  betBox.style.display = (betMode.value === "yes") ? "block" : "none";
  if(state.betEnabled) document.getElementById("betAmt").value = String(state.betAmount||"");

  betMode.addEventListener("change", () => {
    betBox.style.display = (betMode.value === "yes") ? "block" : "none";
  });
}

function renderSetupNames(){
  clearStage();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Nombres de jugadores"]),
    el("p",{},["Escribe el nombre de cada jugador. No puedes continuar si falta alguno."])
  ]);

  const wrap = el("div",{class:"grid2"});
  for(let i=0;i<state.playerCount;i++){
    const id = "nm_"+i;
    wrap.appendChild(el("div",{},[
      el("label",{for:id},[`Jugador ${i+1}`]),
      el("input",{id, type:"text", maxlength:"18", value: state.players[i]?.name || "", placeholder:"Nombre"})
    ]));
  }

  panel.appendChild(wrap);
  panel.appendChild(el("div",{class:"row"},[
    el("button",{class:"btn",type:"button",onclick:() => setStep("setup_count")},["‚¨Ö Atr√°s"]),
    el("button",{class:"btn btn-primary",type:"button",onclick:() => {
      const names = [];
      for(let i=0;i<state.playerCount;i++){
        const v = (document.getElementById("nm_"+i).value||"").trim();
        if(!v){ toast("Completa todos los nombres.", true); return; }
        names.push(v);
      }
      const normed = names.map(norm);
      const set = new Set(normed);
      if(set.size !== normed.length){
        toast("Evita nombres repetidos para votar mejor.", true);
        return;
      }
      for(let i=0;i<state.playerCount;i++){
        state.players[i].name = names[i];
        state.players[i].alive = true;
      }
      setStep("setup_impostors");
    }},["Siguiente"])
  ]));

  stage.appendChild(panel);
}

function renderSetupImpostors(){
  clearStage();

  const maxImp = Math.max(1, Math.floor(state.playerCount/3));
  const current = Math.min(Math.max(1, state.impostorCount || 1), maxImp);

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Cantidad de impostores"]),
    el("p",{},["Selecciona cu√°ntos impostores habr√°. (M√≠nimo 1)."]),
    el("label",{for:"imp"},["Impostores (1 a m√°ximo sugerido)"]),
    el("input",{id:"imp",type:"number",min:"1",max:String(maxImp),inputmode:"numeric",value:String(current)}),
    el("div",{class:"help"},[`M√°ximo sugerido para ${state.playerCount} jugadores: ${maxImp}.`]),

    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => setStep("setup_names")},["‚¨Ö Atr√°s"])
    ]),
    el("div",{class:"row-center"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        const v = Math.floor(Number(document.getElementById("imp").value||0));
        if(!Number.isFinite(v) || v < 1 || v > maxImp){
          toast(`La cantidad de impostores debe estar entre 1 y ${maxImp}.`, true);
          return;
        }
        // Also ensure names are present (safety)
        if(state.players.some(p => !p.name || !p.name.trim())){
          toast("Faltan nombres. Vuelve y completa los jugadores.", true);
          setStep("setup_names");
          return;
        }
        state.impostorCount = v;
        startNewGame();
      }},["üé¥ Repartir tarjetas"])
    ])
  ]);

  stage.appendChild(panel);
}

function renderReveal(){
  clearStage();

  const total = state.players.length;
  const idx = state.revealIndex;
  const p = state.players[idx];

  const roleTxt = (p.role === "impostor") ? "IMPOSTOR" : "CIVIL";
  const roleColor = (p.role === "impostor") ? "var(--bad)" : "var(--good)";
  const wordTxt = (p.role === "impostor") ? "‚Äî" : state.secretWord;

  const card = el("div",{class:"secretCard",id:"secretCard"},[
    el("div",{class:"secretHeader"},[
      el("div",{class:"avatarIcon","aria-hidden":"true"},["üë§"]),
      el("div",{class:"playerName"},[p.name])
    ]),
    el("div",{class:"role",style:`color:${roleColor}`},[roleTxt]),
    el("div",{class:"word"},[wordTxt]),
    el("div",{class:"mask",id:"mask",role:"button",tabindex:"0"},[
      el("div",{class:"maskInner"},[
        el("h3",{},["Tarjeta privada"]),
        el("p",{},["Aseg√∫rate de que nadie est√© mirando."]),
        el("button",{class:"holdBtn",type:"button",id:"holdBtn"},["Mant√©n presionado para ver"])
      ])
    ])
  ]);

  const nextBtn = el("button",{
    class:"btn btn-primary bottomNext",
    type:"button",
    disabled:"disabled",
    onclick:() => {
      state.revealIndex++;
      if(state.revealIndex >= total){
        setStep("briefing");
      }else{
        setStep("reveal");
      }
    }
  },[idx === total-1 ? "‚ñ∂ Continuar" : "Siguiente jugador"]);

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Reparto de tarjetas"]),
    el("p",{},[
      `Jugador ${idx+1} de ${total}. Pasa el tel√©fono a `,
      el("b",{},[p.name]),
      "."
    ]),
    el("div",{class:"revealWrap"},[
      card,
      nextBtn
    ]),
    el("div",{class:"help"},["Para avanzar: suelta para ocultar y luego pulsa ‚ÄúSiguiente jugador‚Äù."])
  ]);

  stage.appendChild(panel);

  const secretCard = document.getElementById("secretCard");
  const holdBtn = document.getElementById("holdBtn");
  let holding = false;
  let holdTimer = null;
  const HOLD_MS = 200;

  function revealOn(){ secretCard.classList.add("revealed"); }
  function revealOff(){
    secretCard.classList.remove("revealed");
    nextBtn.disabled = false;
    nextBtn.removeAttribute("disabled");
  }
  function startHold(e){
    e.preventDefault();
    holding = true;
    clearTimeout(holdTimer);
    holdTimer = setTimeout(() => { if(holding) revealOn(); }, HOLD_MS);
  }
  function endHold(e){
    if(e) e.preventDefault();
    holding = false;
    clearTimeout(holdTimer);
    revealOff();
  }

  holdBtn.addEventListener("pointerdown", startHold);
  holdBtn.addEventListener("pointerup", endHold);
  holdBtn.addEventListener("pointercancel", endHold);
  holdBtn.addEventListener("pointerleave", endHold);

  holdBtn.addEventListener("keydown", (e) => {
    if(e.code === "Space" || e.code === "Enter"){ startHold(e); }
  });
  holdBtn.addEventListener("keyup", (e) => {
    if(e.code === "Space" || e.code === "Enter"){ endHold(e); }
  });
}

function renderBriefing(){
  clearStage();

  const imp = getAliveImpostors().length;
  const civ = getAliveCivilians().length;
  const pot = computePot();

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Listos para jugar"]),
    el("p",{},[
      "Ahora conversen por turnos. Cada jugador dice una pista relacionada con la palabra, sin decirla literalmente."
    ]),
    state.betEnabled
      ? el("div",{class:"resultCard"},[
          el("div",{class:"ttl"},["Apuesta activa"]),
          el("div",{class:"mut"},[
            `Cada jugador pone ${state.betAmount}. Total en la mesa: ${pot}.`
          ])
        ])
      : el("div",{class:"resultCard"},[
          el("div",{class:"ttl"},["Sin apuesta"]),
          el("div",{class:"mut"},["Esta ronda se juega solo por diversi√≥n."])
        ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Resumen (anfitri√≥n)"]),
      el("div",{class:"mut"},[
        `Civiles: ${civ}. Impostores: ${imp}. Votaciones disponibles: ${state.votesAllowed}.`
      ])
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => {
        // new word, new roles, keep coins and betting settings
        state.secretWord = pickSecretWord();
        assignRoles();
        state.revealIndex = 0;
        setStep("reveal");
      }},["‚Üª Repartir otra palabra"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        state.turnIndex = 0;
        state.votes = new Map();
        state.impostorGuesses = new Map();
        setStep("turn");
      }},["üó≥ Empezar votaci√≥n"])
    ]),
    el("div",{class:"help"},["En votaci√≥n: civiles votan. Impostores no votan: solo escriben la palabra que creen correcta."])
  ]);

  stage.appendChild(panel);
}

function renderTurn(){
  clearStage();

  // if no more votes, end by survival rule
  if(state.votesUsed >= state.votesAllowed){
    state.finished = true;
    state.winner = "impostores";
    return setStep("end");
  }

  const alive = getAlivePlayers();
  if(alive.length < 2){
    state.finished = true;
    state.winner = "civiles";
    return setStep("end");
  }

  // find next alive player turn in order
  let next = null;
  let startIdx = state.turnIndex;
  for(let k=0;k<state.players.length;k++){
    const i = (startIdx + k) % state.players.length;
    const p = state.players[i];
    if(p.alive){
      next = p;
      state.turnIndex = (i + 1) % state.players.length;
      break;
    }
  }
  if(!next){
    return setStep("vote_result");
  }

  // Determine if we are still collecting turns; we need one turn per alive player.
  // We use a simple counter per vote: store in stage dataset.
  const key = "turnsDone_"+state.votesUsed;
  if(state[key] === undefined) state[key] = 0;

  const remaining = getAlivePlayers().length - state[key];

  if(remaining <= 0){
    return setStep("vote_result");
  }

  const isImp = next.role === "impostor";

  if(isImp){
    const panel = el("div",{class:"panel"},[
      el("h2",{},[`Votaci√≥n ${state.votesUsed+1} de ${state.votesAllowed}`]),
      el("p",{},[
        "Pasa el tel√©fono a ",
        el("b",{},[next.name]),
        ". (Impostor) No votas: solo intenta adivinar la palabra."
      ]),
      el("label",{for:"guess"},["¬øCu√°l crees que es la palabra?"]),
      el("input",{id:"guess",type:"text",autocomplete:"off",autocapitalize:"none",placeholder:"Escribe una sola palabra"}),
      el("div",{class:"row"},[
        el("button",{class:"btn btn-primary",type:"button",onclick:() => {
          const g = (document.getElementById("guess").value||"").trim();
          if(!g){
            toast("Escribe una palabra.", true);
            return;
          }
          // store guess
          state.impostorGuesses.set(next.id, g);
          state[key] += 1;
          toast("Listo. Pasa el tel√©fono.", false);
          setTimeout(() => setStep("turn"), 250);
        }},["Confirmar"])
      ]),
      el("div",{class:"help"},["Nadie m√°s debe ver lo que escribes."])
    ]);
    stage.appendChild(panel);
    return;
  }

  // civilian vote
  const suspects = getAlivePlayers().filter(p => p.id !== next.id);

  const panel = el("div",{class:"panel"},[
    el("h2",{},[`Votaci√≥n ${state.votesUsed+1} de ${state.votesAllowed}`]),
    el("p",{},[
      "Pasa el tel√©fono a ",
      el("b",{},[next.name]),
      ". Vota por quien crees que es el impostor."
    ])
  ]);

  const list = el("div",{class:"playersList"});
  const group = "vote_"+next.id+"_"+state.votesUsed;

  for(const s of suspects){
    const rid = `${group}_${s.id}`;
    list.appendChild(el("div",{class:"voteItem"},[
      el("div",{},[
        el("div",{class:"nm"},[s.name]),
        el("small",{},["Seleccionar"])
      ]),
      el("input",{class:"radio",type:"radio",name:group,id:rid,value:s.id})
    ]));
  }

  const btn = el("button",{class:"btn btn-primary",type:"button"},["Confirmar voto"]);
  btn.addEventListener("click", () => {
    const selected = panel.querySelector(`input[name="${group}"]:checked`);
    if(!selected){
      toast("Selecciona un jugador.", true);
      return;
    }
    const suspectId = selected.value;
    state.votes.set(suspectId, (state.votes.get(suspectId)||0) + 1);
    state[key] += 1;
    toast("Voto registrado. Pasa el tel√©fono.", false);
    setTimeout(() => setStep("turn"), 250);
  });

  panel.appendChild(list);
  panel.appendChild(el("div",{class:"row"},[btn]));
  panel.appendChild(el("div",{class:"help"},["Recuerda: los impostores NO votan."]));

  stage.appendChild(panel);
}

function renderVoteResult(){
  clearStage();

  // clear turn counter for next vote
  const key = "turnsDone_"+state.votesUsed;

  // If any impostor guessed correctly, impostors win immediately
  if(checkImpostorGuessWin()){
    awardRoundCoins();
    return setStep("end");
  }

  const eliminatedId = tallyVotes();
  eliminatePlayer(eliminatedId);

  const eliminated = state.players.find(p => p.id === eliminatedId);
  const wasImp = eliminated?.role === "impostor";

  state.votesUsed += 1;

  // award coins each resolved vote-round
  awardRoundCoins();

  // reset maps for next cycle
  state.votes = new Map();
  state.impostorGuesses = new Map();
  state[key] = 0;

  // role-based win check
  if(checkWinnerByRoles()){
    return setStep("end");
  }

  // if votes exhausted after this elimination, impostors win by survival rule
  if(state.votesUsed >= state.votesAllowed){
    state.finished = true;
    state.winner = "impostores";
    return setStep("end");
  }

  const panel = el("div",{class:"panel"},[
    el("h2",{},["Resultado de votaci√≥n"]),
    el("p",{},[
      "Eliminado: ",
      el("b",{},[eliminated?.name || "‚Äî"]),
      "."
    ]),
    el("div",{class: wasImp ? "ok" : "warn"},[
      wasImp ? "Era IMPOSTOR." : "No era impostor."
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn",type:"button",onclick:() => setStep("briefing")},["Volver a pistas"]),
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        state.turnIndex = 0;
        setStep("turn");
      }},["Siguiente votaci√≥n"])
    ])
  ]);

  stage.appendChild(panel);
}

function renderEnd(){
  clearStage();

  const title = state.winner === "impostores" ? "Ganaron los impostores" : "Ganaron los civiles";
  const icon  = state.winner === "impostores" ? "üïµÔ∏è‚Äç‚ôÇÔ∏è" : "üõ°Ô∏è";
  const color = state.winner === "impostores" ? "var(--bad)" : "var(--good)";

  const impsAll = state.players.filter(p => p.role === "impostor");
  const civsAll = state.players.filter(p => p.role === "civil");

  const pot = computePot();

  // payout logic (display-only)
  let payoutText = "Sin apuesta.";
  if(state.betEnabled){
    if(state.winner === "impostores"){
      const aliveImps = getAliveImpostors();
      const secret = norm(state.secretWord);
      const correct = aliveImps.filter(p => {
        const g = state.impostorGuesses.get(p.id);
        return g && norm(g) === secret;
      });
      if(state.impostorCount === 1){
        payoutText = `${aliveImps[0]?.name || "Impostor"} se lleva el total: ${pot}.`;
      }else{
        if(correct.length >= 1){
          const share = Math.floor(pot / correct.length);
          payoutText = `Ganan los impostores. Premio para quienes acertaron la palabra (${correct.map(p=>p.name).join(", ")}): ${share} cada uno. Total: ${pot}.`;
        }else{
          const share = aliveImps.length ? Math.floor(pot / aliveImps.length) : 0;
          payoutText = `Ganan los impostores. Se reparte entre los impostores vivos (${aliveImps.map(p=>p.name).join(", ")}): ${share} cada uno. Total: ${pot}.`;
        }
      }
    }else{
      const aliveCivs = getAliveCivilians();
      const share = aliveCivs.length ? Math.floor(pot / aliveCivs.length) : 0;
      payoutText = `Ganan los civiles. Se reparte entre civiles vivos (${aliveCivs.map(p=>p.name).join(", ")}): ${share} cada uno. Total: ${pot}.`;
    }
  }

  const panel = el("div",{class:"panel"},[
    el("h2",{},[`${icon} ${title}`]),
    el("p",{},[
      "Palabra de la ronda: ",
      el("b",{},[state.secretWord]),
      "."
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl",style:`color:${color}`},["Roles (anfitri√≥n)"]),
      el("div",{class:"mut"},[
        "Impostores: " + (impsAll.map(p=>p.name).join(", ") || "‚Äî"),
        " ¬∑ Civiles: " + (civsAll.map(p=>p.name).join(", ") || "‚Äî")
      ])
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Resultado de apuesta"]),
      el("div",{class:"mut"},[payoutText])
    ]),
    el("div",{class:"resultCard"},[
      el("div",{class:"ttl"},["Monedas acumuladas"]),
      el("div",{class:"mut"},[
        ...state.players.map(p => `${p.name}: ${(p.coins||0)}  `)
      ])
    ]),
    el("div",{class:"row"},[
      el("button",{class:"btn btn-primary",type:"button",onclick:() => {
        // next round (same players, keep coins and bet mode)
        state.votesUsed = 0;
        // refresh word and roles
        state.secretWord = pickSecretWord();
        assignRoles();
        state.revealIndex = 0;
        state.turnIndex = 0;
        state.votes = new Map();
        state.impostorGuesses = new Map();
        setStep("reveal");
      }},["‚ñ∂ Siguiente ronda"]),
      el("button",{class:"btn btn-danger",type:"button",onclick:() => {
        // reset everything
        state.step = "home";
        state.playerCount = 4;
        state.players = [];
        state.impostorCount = 1;
        state.betEnabled = false;
        state.betAmount = 0;

        state.round = 0;
        state.votesAllowed = 0;
        state.votesUsed = 0;

        state.revealIndex = 0;

        state.usedWords = new Set();
        state.wordBank = shuffle(buildWordBank());
        state.secretWord = "";

        state.turnIndex = 0;
        state.votes = new Map();
        state.impostorGuesses = new Map();

        state.finished = false;
        state.winner = "";

        updateHUD();
        setStep("home");
      }},["‚ü≤ Reiniciar todo"])
    ]),
    el("div",{class:"help"},[
      "Regla aplicada: civiles votan; impostores solo intentan adivinar la palabra. Si un impostor acierta, ganan de inmediato."
    ])
  ]);

  stage.appendChild(panel);
}

/* boot */
updateHUD();
document.addEventListener("DOMContentLoaded", () => { setStep("home"); });

})();
</script>
</body>
</html>
